{"ast":null,"code":"var osmtogeojson = require('osmtogeojson'),\n    querystring = require('querystring'),\n    request = require('request'),\n    concat = require('concat-stream'),\n    JSONStream = require('JSONStream'),\n    xmldom = require('xmldom');\n\nmodule.exports = function (query, cb, options) {\n  var contentType;\n  options = options || {};\n\n  var toGeoJSON = function (data) {\n    var geojson;\n    geojson = osmtogeojson(data, {\n      flatProperties: options.flatProperties || false\n    });\n    cb(undefined, geojson);\n  };\n\n  var handleXml = function (data) {\n    var parser = new xmldom.DOMParser();\n    var doc = parser.parseFromString(data);\n    toGeoJSON(doc);\n  };\n\n  var reqOptions = {\n    headers: {\n      'content-type': 'application/x-www-form-urlencoded'\n    },\n    body: querystring.stringify({\n      data: query\n    })\n  };\n  var r;\n\n  if (!global.window) {\n    r = request.post(options.overpassUrl || 'http://overpass-api.de/api/interpreter', reqOptions);\n    r.on('response', function (response) {\n      if (response.statusCode != 200) {\n        r.abort();\n        return cb({\n          message: 'Request failed: HTTP ' + response.statusCode,\n          statusCode: response.statusCode\n        });\n      }\n\n      contentType = response.headers['content-type'];\n\n      if (contentType.indexOf('json') >= 0) {\n        r.pipe(JSONStream.parse()).on('data', toGeoJSON).on('error', cb);\n      } else if (contentType.indexOf('xml') >= 0) {\n        var body = '';\n        r.on('data', function (chunk) {\n          body += chunk;\n        }).on('end', function () {\n          handleXml(body);\n        });\n      } else {\n        cb({\n          message: 'Unknown Content-Type \"' + contentType + '\" in response'\n        });\n      }\n    }).on('error', cb);\n  } else {\n    r = request.post(options.overpassUrl || 'http://overpass-api.de/api/interpreter', reqOptions, function (error, response, body) {\n      if (!error && response.statusCode === 200) {\n        toGeoJSON(JSON.parse(body));\n      } else if (error) {\n        cb(error);\n      } else if (response) {\n        cb({\n          message: 'Request failed: HTTP ' + response.statusCode,\n          statusCode: response.statusCode\n        });\n      } else {\n        cb({\n          message: 'Unknown error.'\n        });\n      }\n    });\n  }\n\n  return r;\n};","map":null,"metadata":{},"sourceType":"script"}